DelegatedAccount (UUPS Upgradeable)
├── initialize
│   ├── when owner is zero address
│   │   └── it should revert with OwnableInvalidOwner.
│   ├── when exchange is zero address
│   │   └── it should revert with ZeroAddress.
│   ├── when collateralToken is zero address
│   │   └── it should revert with ZeroAddress.
│   ├── when already initialized
│   │   └── it should revert with InvalidInitialization.
│   ├── when operator is zero address
│   │   └── it should allow initialization (operator is optional).
│   └── when all parameters are valid
│       ├── it should set the owner.
│       ├── it should set the operator.
│       ├── it should set the exchange.
│       ├── it should set the collateralToken.
│       ├── it should give infinite approval to exchange.
│       └── it should initialize operator allowlist with default selectors.
├── fallback
│   ├── when caller is not owner or operator
│   │   └── it should revert with OnlyOwnerOrOperator.
│   ├── when caller is owner
│   │   ├── when exchange call fails
│   │   │   └── it should bubble up the revert.
│   │   └── when exchange call succeeds
│   │       └── it should return the call result.
│   └── when caller is operator
│       ├── when account does not exist
│       │   └── it should revert with AccountNotCreated.
│       ├── when calldata length is less than 4 bytes
│       │   └── it should revert with SelectorNotAllowed.
│       ├── when selector is not allowlisted
│       │   └── it should revert with SelectorNotAllowed.
│       └── when selector is allowlisted
│           ├── when exchange call fails
│           │   └── it should bubble up the revert.
│           └── when exchange call succeeds
│               └── it should return the call result.
├── transferOwnership (two-step)
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is owner
│       └── when newOwner is valid
│           ├── it should set pendingOwner.
│           └── it should emit OwnershipTransferStarted event.
├── acceptOwnership
│   ├── when caller is not pending owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is pending owner
│       ├── it should transfer ownership.
│       └── it should clear pendingOwner.
├── addOperator
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   ├── when operator is zero address
│   │   └── it should revert with ZeroAddress.
│   └── when caller is owner
│       ├── it should add operator to mapping.
│       └── it should emit OperatorAdded event.
├── removeOperator
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is owner
│       ├── it should remove operator from mapping.
│       └── it should emit OperatorRemoved event.
├── isOperator
│   ├── when address is an operator
│   │   └── it should return true.
│   └── when address is not an operator
│       └── it should return false.
├── setOperatorAllowlist
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is owner
│       ├── when adding a selector
│       │   ├── it should update allowlist.
│       │   └── it should emit OperatorAllowlistUpdated event.
│       └── when removing a selector
│           ├── it should update allowlist.
│           └── it should emit OperatorAllowlistUpdated event.
├── createAccount
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is owner
│       ├── when account already exists
│       │   └── it should revert with AccountAlreadyCreated.
│       └── when account does not exist
│           ├── when exchange call fails
│           │   └── it should bubble up the Exchange error.
│           └── when exchange call succeeds
│               ├── it should store the accountId.
│               └── it should emit AccountCreated event.
├── withdrawCollateral
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is owner
│       ├── when exchange call fails
│       │   └── it should bubble up the Exchange error.
│       └── when exchange call succeeds
│           ├── it should call withdrawCollateral on exchange.
│           └── it should transfer tokens to owner.
├── rescueTokens
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is owner
│       └── it should transfer tokens to owner.
├── upgradeToAndCall
│   ├── when caller is not owner
│   │   └── it should revert with OwnableUnauthorizedAccount.
│   └── when caller is owner
│       ├── it should upgrade to the new implementation.
│       ├── it should preserve all state after upgrade.
│       ├── it should allow calling init data during upgrade.
│       └── when new implementation is not UUPS compatible
│           └── it should revert.
└── isOperatorAllowed
    ├── when selector is in default allowlist
    │   └── it should return true.
    └── when selector is not allowlisted
        └── it should return false.
